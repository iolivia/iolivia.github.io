{"data":{"site":{"siteMetadata":{"fullName":"olivia ifrim","settings":{"disqusShortName":"oliviaifrim"},"twitterHandle":"@oliviff"}},"markdownRemark":{"id":"05e4af50-0cac-5bc5-ab10-a48c5fcd06ca","html":"<p><a href=\"/posts/4-bloom-filter-part-3/\">Last time</a> we looked at Bloom filters, which is one type of probabilistic data structure. In this post we will look at another one - <a href=\"https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch\">Count Min Sketch</a>.   </p>\n<p>In short, a count min sketch is used to:</p>\n<ul>\n<li>consume a stream of events, where each event has an event type</li>\n<li>query for the frequency of a particular event type in a sketch</li>\n<li>query for the frequency of a particular event type in two different sketches (this will give us the inner product of the frequencies of the event in the two sketches)</li>\n</ul>\n<p>It's important to note that due to the risk of collisions and the size of the sketch, it can overestimate the true frequency of the events. It is after all a probabilistic data structure, it doesn't store the raw data, much like the Bloom filter, so this is expected. </p>\n<p>So let's see how the sketch works. </p>\n<p>We will need:</p>\n<ul>\n<li>a 2D array of <code class=\"language-text\">rows</code> x <code class=\"language-text\">rows</code> (<code class=\"language-text\">rows</code> and <code class=\"language-text\">cols</code> should be chosed based on the estimated number of unique event types inserted into the sketch)</li>\n<li>one hash function per row (the hash functions should be independent)</li>\n</ul>\n<p>We'll start off with a blank 2D array. </p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// rows = 3, cols = 5</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span></code></pre></div>\n<p>Now let's insert some events.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// This will insert an event of type \"A\".</span>\n<span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// For each row, we'll hash the event type with the</span>\n<span class=\"token comment\">// hashing function for that row to get an index k</span>\n<span class=\"token comment\">// h0(\"A\") - 2</span>\n<span class=\"token comment\">// h1(\"A\") - 4</span>\n<span class=\"token comment\">// h2(\"A\") - 0</span>\n\n<span class=\"token comment\">// And now we index into every row with the computed k</span>\n<span class=\"token comment\">// and increment by one.</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">1</span>\n<span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span></code></pre></div>\n<p>Now an event of a different type.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"B\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// h0(\"B\") - 1</span>\n<span class=\"token comment\">// h1(\"B\") - 4</span>\n<span class=\"token comment\">// h2(\"B\") - 3</span>\n<span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">2</span>\n<span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">0</span></code></pre></div>\n<p>Rememeber we are inserting a stream of events, so we will have many events of the same type. So let's insert another event of type \"A\";</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// h0(\"A\") - 2</span>\n<span class=\"token comment\">// h1(\"A\") - 4</span>\n<span class=\"token comment\">// h2(\"A\") - 0</span>\n<span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">2</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n<span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">3</span>\n<span class=\"token number\">2</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span> <span class=\"token number\">1</span> <span class=\"token number\">0</span></code></pre></div>\n<p>Great, now how do we query for the frequency of an event?</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token function\">getFrequency</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// This is our state</span>\n<span class=\"token comment\">// 0 1 2 0 0</span>\n<span class=\"token comment\">// 0 0 0 0 3</span>\n<span class=\"token comment\">// 2 0 0 1 0</span>\n\n<span class=\"token comment\">// We'll hash again, just like when inserting.</span>\n<span class=\"token comment\">// h0(\"A\") - 2</span>\n<span class=\"token comment\">// h1(\"A\") - 4</span>\n<span class=\"token comment\">// h2(\"A\") - 0</span>\n\n<span class=\"token comment\">// Now for every row we'll get sketch[row, hrow(\"A\")]</span>\n<span class=\"token comment\">// sketch[0, 2] - 2 (the frequency on this row is 2)</span>\n<span class=\"token comment\">// sketch[1, 4] - 3 (the frequency on this row is 3)</span>\n<span class=\"token comment\">// sketch[2, 0] - 2 (the frequency on this row is 2)</span>\n\n<span class=\"token comment\">// And now we take the min of those</span>\n<span class=\"token comment\">// min(2, 3, 2)</span>\n<span class=\"token number\">2</span></code></pre></div>\n<p>Next up, we'll implement this. We already have all the building blocks for double hashing from the Bloom filter so the implementation should be pretty straight-forward. </p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> CountMinSketch<span class=\"token operator\">::</span><span class=\"token function\">insert</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string <span class=\"token operator\">&amp;</span> key<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t row <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> row <span class=\"token operator\">&lt;</span> m_rows<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>row<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Hash </span>\n        <span class=\"token keyword\">auto</span> k <span class=\"token operator\">=</span> m_hash<span class=\"token punctuation\">.</span><span class=\"token function\">hashIteration</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">,</span> m_cols<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Increment</span>\n        <span class=\"token operator\">++</span><span class=\"token punctuation\">(</span>m_vector<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">uint32_t</span> CountMinSketch<span class=\"token operator\">::</span><span class=\"token function\">getFrequency</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string <span class=\"token operator\">&amp;</span> key<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n<span class=\"token punctuation\">{</span>\n    size_t minFrequency <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span>numeric_limits<span class=\"token operator\">&lt;</span>std<span class=\"token operator\">::</span>size_t<span class=\"token operator\">></span><span class=\"token operator\">::</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>size_t row <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> row <span class=\"token operator\">&lt;</span> m_rows<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>row<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Hash </span>\n        <span class=\"token keyword\">auto</span> k <span class=\"token operator\">=</span> m_hash<span class=\"token punctuation\">.</span><span class=\"token function\">hashIteration</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> row<span class=\"token punctuation\">,</span> m_cols<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// Find min </span>\n        <span class=\"token keyword\">auto</span> currentFrequency <span class=\"token operator\">=</span> m_vector<span class=\"token punctuation\">[</span>row<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>k<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentFrequency <span class=\"token operator\">&lt;</span> minFrequency<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            minFrequency <span class=\"token operator\">=</span> currentFrequency<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> minFrequency<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can see the full implementation at <a href=\"https://github.com/iolivia/bloom-filter/tree/master/BloomFilter/src/Sketch\">Sketch</a>.</p>","excerpt":"Last time  we looked at Bloom filters, which is one type of probabilistic data structure. In this post we will look at another one -  Count…","frontmatter":{"title":"Count min sketch explained","date":"June 02, 2017","tags":["sketch","count min sketch","hashing","cpp","c++"],"featuredImage":{"childImageSharp":{"sizes":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHcksJHB//EABcQAAMBAAAAAAAAAAAAAAAAAAEQEiD/2gAIAQEAAQUCVnH/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAAAgQEgMv/aAAgBAQAGPwJjMzT/xAAbEAABBAMAAAAAAAAAAAAAAAABABARMVFx0f/aAAgBAQABPyECKYGS0uqG/9oADAMBAAIAAwAAABCgz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABsQAAIDAQEBAAAAAAAAAAAAAAERACFBMVFh/9oACAEBAAE/EMQgWTgDHDWoCwTnjny4jVHcX0i3AE1pc//Z","aspectRatio":2.3333333333333335,"src":"/static/e1cde154129c4117ac8c3b92ea2cebc7/805f7/sketch.jpg","srcSet":"/static/e1cde154129c4117ac8c3b92ea2cebc7/cbd46/sketch.jpg 175w,\n/static/e1cde154129c4117ac8c3b92ea2cebc7/bc31f/sketch.jpg 350w,\n/static/e1cde154129c4117ac8c3b92ea2cebc7/805f7/sketch.jpg 640w","sizes":"(max-width: 640px) 100vw, 640px"}}}}}},"pageContext":{"slug":"/posts/5-count-min-sketch/","previous":{"fields":{"slug":"/posts/4-bloom-filter-part-3/"},"frontmatter":{"title":"Implementing a Bloom filter - Part 3"}},"next":{"fields":{"slug":"/posts/6-run-length-encoder/"},"frontmatter":{"title":"Encoding - Run length encoder"}}}}