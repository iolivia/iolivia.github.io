{"data":{"site":{"siteMetadata":{"fullName":"olivia ifrim","settings":{"disqusShortName":"oliviaifrim"},"twitterHandle":"@oliviff"}},"markdownRemark":{"id":"b1874894-64c0-598f-9f05-6e22700c8c7f","html":"<p>Last time we looked at how the internals of Bloom filters work. In this post, we'll get our hands dirty and implement it. </p>\n<p>We'll set up an interface with pure virtuals. </p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">IBloomFilter</span> \n<span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>std<span class=\"token operator\">::</span>string input<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">isMaybePresent</span><span class=\"token punctuation\">(</span>std<span class=\"token operator\">::</span>string input<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now we'll need to pick something to use as our array of bits. The two obvious choices are <a href=\"http://www.cplusplus.com/reference/bitset/bitset/\"><code class=\"language-text\">std::bitset</code></a> and <a href=\"http://www.cplusplus.com/reference/vector/vector-bool/\"><code class=\"language-text\">std::vector&lt;bool&gt;</code></a>. Since we want the user of the Bloom filter to specify its size at construction time, we will need to go with the vector. </p>\n<p>Here is our class definition. </p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">BloomFilter</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">public</span> IBloomFilter <span class=\"token punctuation\">{</span>\n\n<span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n    <span class=\"token function\">BloomFilter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> Hash<span class=\"token operator\">&amp;</span> hash<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> size<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> k<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Inherited via IBloomFilter</span>\n    <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span>std<span class=\"token operator\">::</span>string input<span class=\"token punctuation\">)</span> override<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">virtual</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">isMaybePresent</span><span class=\"token punctuation\">(</span>std<span class=\"token operator\">::</span>string input<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span> override<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span><span class=\"token operator\">:</span>\n    Hash m_hash<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> m_k<span class=\"token punctuation\">;</span>\n    std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">bool</span><span class=\"token operator\">></span> m_vector<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now, you might be asking how we will pick <code class=\"language-text\">k</code> hashing functions. What we actually need is <code class=\"language-text\">k</code> functions which will somehow hash the input, give us <code class=\"language-text\">k</code> different indexes into our bit vector and ensure that these results are consistent. </p>\n<p>But, how can we pick <code class=\"language-text\">k</code> different ways of hashing? There are only a fixed number of <a href=\"https://en.wikipedia.org/wiki/List_of_hash_functions\">hashing algorithms</a>, and in theory our <code class=\"language-text\">k</code> could be anything. Luckily, there is a way of generating a different hash based on the iteration number, this technique is called <a href=\"https://en.wikipedia.org/wiki/Double_hashing\">double hashing</a>. Let's see how this works. </p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">h(input, iteration) = h1(input) + iteration * h2(input)</code></pre></div>\n<p>So all we have to do is pick 2 different hashing functions, and for every iteration compute the final hash using the formula above. </p>\n<p>We will use <a href=\"https://github.com/aappleby/smhasher\">Murmur Hash</a> for generating the two unique hashes.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">std<span class=\"token operator\">::</span>array<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token operator\">></span> Hash<span class=\"token operator\">::</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string <span class=\"token operator\">&amp;</span> input<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n<span class=\"token punctuation\">{</span>\n    std<span class=\"token operator\">::</span>array<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token operator\">></span> out<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">MurmurHash3_x86_32</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">sizeof</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> out<span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> out<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And now we just apply the forumula for every iteration. We also modulo with the size of our filter to make sure the numbers we get are actually in our Bloom filter range.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\">std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token operator\">></span> Hash<span class=\"token operator\">::</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> std<span class=\"token operator\">::</span>string<span class=\"token operator\">&amp;</span> input<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> iterations<span class=\"token punctuation\">,</span> <span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> max<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">auto</span> hashesIndexed <span class=\"token operator\">=</span> std<span class=\"token operator\">::</span>vector<span class=\"token operator\">&lt;</span><span class=\"token keyword\">uint32_t</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">auto</span> hashedInput <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">auto</span> firstHash <span class=\"token operator\">=</span> hashedInput<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">auto</span> secondHash <span class=\"token operator\">=</span> hashedInput<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">unsigned</span> <span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> iterations<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">auto</span> hashedInputInt <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>firstHash <span class=\"token operator\">+</span> secondHash <span class=\"token operator\">*</span> i<span class=\"token punctuation\">)</span> <span class=\"token operator\">%</span> max<span class=\"token punctuation\">;</span>\n        hashesIndexed<span class=\"token punctuation\">.</span><span class=\"token function\">push_back</span><span class=\"token punctuation\">(</span>hashedInputInt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> hashesIndexed<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Now that we have all the moving parts, we can easily implement <code class=\"language-text\">put</code> and <code class=\"language-text\">isMaybePresent</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token keyword\">void</span> BloomFilter<span class=\"token operator\">::</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>std<span class=\"token operator\">::</span>string input<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Hash and get k indexes</span>\n    <span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> indexes <span class=\"token operator\">=</span> m_hash<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> m_k<span class=\"token punctuation\">,</span> m_vector<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Set all those bits to 1</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> index <span class=\"token operator\">:</span> indexes<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        m_vector<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">bool</span> BloomFilter<span class=\"token operator\">::</span><span class=\"token function\">isMaybePresent</span><span class=\"token punctuation\">(</span>std<span class=\"token operator\">::</span>string input<span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Hash and get k indexes</span>\n    <span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> indexes <span class=\"token operator\">=</span> m_hash<span class=\"token punctuation\">.</span><span class=\"token function\">hash</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">,</span> m_k<span class=\"token punctuation\">,</span> m_vector<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// Find if all bits are set</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> <span class=\"token keyword\">auto</span><span class=\"token operator\">&amp;</span> index <span class=\"token operator\">:</span> indexes<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m_vector<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And this is pretty much it. You can see the full code at <a href=\"https://github.com/iolivia/bloom-filter\">iolivia/bloom-filter</a>. Next up we'll do some experiments with <code class=\"language-text\">n</code> and <code class=\"language-text\">k</code> and see what our error rates are.</p>","excerpt":"Last time we looked at how the internals of Bloom filters work. In this post, we'll get our hands dirty and implement it.  We'll set up anâ€¦","frontmatter":{"title":"Implementing a Bloom filter - Part 3","date":"May 24, 2017","tags":["bloom filter","bloom","cpp","c++"],"featuredImage":{"childImageSharp":{"sizes":{"src":"/static/4836718e198b6a8cdbecc763fb6384a3/81388/bloom-flower-3.jpg","base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAAEAgP/2gAMAwEAAhADEAAAARleQ6zigTn/AP/EABsQAAIBBQAAAAAAAAAAAAAAAAIDIgARM0FD/9oACAEBAAEFAlxoiuJnLltuX//EABYRAQEBAAAAAAAAAAAAAAAAAAABEf/aAAgBAwEBPwGMf//EABgRAAMBAQAAAAAAAAAAAAAAAAABEQIh/9oACAECAQE/Ad2iXD//xAAbEAAABwEAAAAAAAAAAAAAAAAAAQIQERIhcf/aAAgBAQAGPwK+FLYUBLK6P//EABwQAAICAgMAAAAAAAAAAAAAAAABESFRsRAxgf/aAAgBAQABPyHKQilR2UCcZos+Rs3oWvBf/9oADAMBAAIAAwAAABAIH//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8QmQej/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAgEBPxBtKKg//8QAHBABAAICAwEAAAAAAAAAAAAAAQARMUEhYfCh/9oACAEBAAE/ELsYSOwtN9wC5Ry02RKaY0l4dzydzL7mfQn/2Q==","aspectRatio":2.3333333333333335,"srcSet":"/static/4836718e198b6a8cdbecc763fb6384a3/cb2d9/bloom-flower-3.jpg 175w,\n/static/4836718e198b6a8cdbecc763fb6384a3/7e73d/bloom-flower-3.jpg 350w,\n/static/4836718e198b6a8cdbecc763fb6384a3/81388/bloom-flower-3.jpg 688w","sizes":"(max-width: 688px) 100vw, 688px"}}}}}},"pageContext":{"slug":"/posts/4-bloom-filter-part-3/","previous":{"fields":{"slug":"/posts/3-bloom-filter-part-2/"},"frontmatter":{"title":"Implementing a Bloom filter - Part 2"}},"next":{"fields":{"slug":"/posts/5-count-min-sketch/"},"frontmatter":{"title":"Count min sketch explained"}}}}